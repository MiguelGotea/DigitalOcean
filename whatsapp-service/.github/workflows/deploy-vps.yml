name: ðŸš€ Deploy WhatsApp Service â€” DigitalOcean VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_KEY }}

    - name: ðŸ“¤ Sincronizar cÃ³digo fuente al VPS
      run: |
        echo "ðŸ”„ Sincronizando whatsapp-service â†’ VPS..."
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='auth/' \
          --exclude='logs/' \
          --exclude='.env' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/whatsapp-service/

    - name: ðŸ”§ Propagar cambios a instancias y reiniciar PM2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          set -e

          deploy_instancia() {
            local INST=$1
            local DIR="/var/www/${INST}"
            echo "ðŸ“¦ Actualizando ${DIR}..."
            rsync -a \
              --exclude='node_modules/' \
              --exclude='auth/' \
              --exclude='.env' \
              --exclude='logs/' \
              /var/www/whatsapp-service/ \
              ${DIR}/
            echo "âœ… ${INST} actualizado"
          }

          deploy_instancia wsp-clientes
          deploy_instancia wsp-crmbot

          echo "ðŸ” Reiniciando instancias PM2..."
          pm2 restart wsp-clientes
          pm2 restart wsp-crmbot
          pm2 save

          echo "âœ… Deploy completado"
          pm2 list
        EOF

    - name: âœ… Verificar deploy
      run: |
        echo "âœ… Deploy VPS completado exitosamente"
        echo "ðŸŒ VPS: ${{ secrets.DO_HOST }}"
        echo "ðŸ“ Instancias actualizadas: wsp-clientes, wsp-crmbot"
