name: ğŸš€ Deploy WhatsApp Services â€” DigitalOcean VPS

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CÃ“MO AGREGAR UNA NUEVA ENTIDAD:
#  1. Crear la carpeta   DigitalOcean/wsp-nueva/ con todo el cÃ³digo
#  2. Copiar el bloque rsync de abajo y cambiar el nombre
#  3. Agregar "pm2 restart wsp-nueva" en el paso PM2
#  4. Push â†’ GitHub Actions desplegarÃ¡ automÃ¡ticamente
#
#  PRIMER DEPLOY DE UNA NUEVA ENTIDAD (solo SSH una vez):
#    ssh root@<IP>
#    cd /var/www/wsp-nueva
#    npm install --production
#    cp .env.example .env && nano .env   â† llenar WSP_TOKEN
#    pm2 start ecosystem.config.js && pm2 save
#
#  DespuÃ©s de eso: todo es push. Cero SSH para cÃ³digo.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_KEY }}

    # â”€â”€ Instancia 1: CampaÃ±as de marketing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Deploy wsp-clientes â†’ /var/www/wsp-clientes/
      run: |
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='logs/' \
          --exclude='.env' \
          --exclude='.wwebjs_auth*' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-clientes/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-clientes/

    # â”€â”€ Instancia 2: CRM Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Deploy wsp-crmbot â†’ /var/www/wsp-crmbot/
      run: |
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='logs/' \
          --exclude='.env' \
          --exclude='.wwebjs_auth*' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-crmbot/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-crmbot/

    # â”€â”€ Instancia 3: Notificaciones de planilla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¤ Deploy wsp-planilla â†’ /var/www/wsp-planilla/
      run: |
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='logs/' \
          --exclude='.env' \
          --exclude='.wwebjs_auth*' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-planilla/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-planilla/

    # â”€â”€ Reinicio PM2 (solo instancias activas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Reiniciar instancias PM2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          # Reiniciar solo si el proceso estÃ¡ registrado en PM2
          pm2 restart wsp-clientes  --update-env || true
          pm2 restart wsp-crmbot    --update-env || true
          pm2 restart wsp-planilla  --update-env || true
          pm2 save
          echo "---"
          pm2 list
        EOF

    - name: âœ… Deploy completado
      run: |
        echo "âœ… Deploy completado"
        echo "ğŸ“ wsp-clientes  â†’ /var/www/wsp-clientes/"
        echo "ğŸ“ wsp-crmbot    â†’ /var/www/wsp-crmbot/"
        echo "ğŸ“ wsp-planilla  â†’ /var/www/wsp-planilla/"
        echo "ğŸŒ VPS: ${{ secrets.DO_HOST }}"
