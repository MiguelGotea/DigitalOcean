name: ğŸš€ Deploy WhatsApp Service â€” DigitalOcean VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_KEY }}

    - name: ğŸ“¤ Deploy wsp-clientes â†’ /var/www/wsp-clientes/
      run: |
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='auth/' \
          --exclude='logs/' \
          --exclude='.env' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-clientes/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-clientes/

    - name: ğŸ“¤ Deploy wsp-crmbot â†’ /var/www/wsp-crmbot/
      run: |
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='auth/' \
          --exclude='logs/' \
          --exclude='.env' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-crmbot/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-crmbot/

    - name: ğŸ” Reiniciar instancias PM2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          pm2 restart wsp-clientes
          pm2 restart wsp-crmbot
          pm2 save
          echo "---"
          pm2 list
        EOF

    - name: âœ… Deploy completado
      run: |
        echo "âœ… Deploy completado exitosamente"
        echo "ğŸ“ wsp-clientes â†’ /var/www/wsp-clientes/"
        echo "ğŸ“ wsp-crmbot   â†’ /var/www/wsp-crmbot/"
        echo "ğŸŒ VPS: ${{ secrets.DO_HOST }}"
