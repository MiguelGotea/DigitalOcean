name: ðŸš€ Deploy WhatsApp Service â€” DigitalOcean VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_KEY }}

    - name: ðŸ“¤ Sincronizar whatsapp-service (cÃ³digo fuente compartido)
      run: |
        echo "ðŸ”„ Sincronizando whatsapp-service â†’ /var/www/whatsapp-service/"
        rsync -avz \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gemini/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='auth/' \
          --exclude='logs/' \
          --exclude='.env' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./whatsapp-service/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/whatsapp-service/

    - name: ðŸ“¤ Sincronizar wsp-clientes (config instancia)
      run: |
        echo "ðŸ”„ Sincronizando wsp-clientes â†’ /var/www/wsp-clientes/"
        rsync -avz \
          --exclude='.env' \
          --exclude='auth/' \
          --exclude='node_modules/' \
          --exclude='logs/' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-clientes/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-clientes/

    - name: ðŸ“¤ Sincronizar wsp-crmbot (config instancia)
      run: |
        echo "ðŸ”„ Sincronizando wsp-crmbot â†’ /var/www/wsp-crmbot/"
        rsync -avz \
          --exclude='.env' \
          --exclude='auth/' \
          --exclude='node_modules/' \
          --exclude='logs/' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./wsp-crmbot/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/wsp-crmbot/

    - name: ðŸ”§ Propagar cÃ³digo fuente a instancias y reiniciar PM2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          set -e

          propagar() {
            local INST=$1
            echo "ðŸ“¦ Propagando cÃ³digo fuente â†’ /var/www/${INST}/"
            rsync -a \
              --exclude='node_modules/' \
              --exclude='auth/' \
              --exclude='.env' \
              --exclude='logs/' \
              /var/www/whatsapp-service/ \
              /var/www/${INST}/
            echo "âœ… ${INST} actualizado"
          }

          propagar wsp-clientes
          propagar wsp-crmbot

          echo "ðŸ” Reiniciando PM2..."
          pm2 restart wsp-clientes
          pm2 restart wsp-crmbot
          pm2 save

          echo "---"
          pm2 list
        EOF

    - name: âœ… Verificar deploy
      run: |
        echo "âœ… Deploy completado"
        echo "ðŸŒ VPS: ${{ secrets.DO_HOST }}"
        echo "ðŸ“ wsp-clientes  â†’ /var/www/wsp-clientes/"
        echo "ðŸ“ wsp-crmbot    â†’ /var/www/wsp-crmbot/"
