name: ğŸš€ Deploy WhatsApp Service - DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DO_SSH_KEY }}

    - name: ğŸ“¤ Sincronizar archivos al VPS (rsync)
      run: |
        echo "ğŸ”„ Sincronizando whatsapp-service al VPS..."

        rsync -avz \
          --delete \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gitignore' \
          --exclude='node_modules/' \
          --exclude='.wwebjs_auth/' \
          --exclude='.wwebjs_cache/' \
          --exclude='sessions/' \
          --exclude='logs/' \
          --exclude='.env' \
          -e "ssh -o StrictHostKeyChecking=no -p 22" \
          ./whatsapp-service/ \
          ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:${{ secrets.DO_PATH }}/

    - name: ğŸ“¦ Instalar dependencias en VPS
      run: |
        echo "ğŸ“¦ Instalando dependencias Node.js..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          cd ${{ secrets.DO_PATH }}
          npm install --production --omit=dev
        EOF

    - name: ğŸ”„ Recargar servicio con PM2
      run: |
        echo "ğŸ”„ Recargando servicio PM2..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          cd ${{ secrets.DO_PATH }}
          # Recargar todas las instancias definidas en ecosystem.config.js
          # Si ya existen los procesos PM2, recargarlos; si no, iniciarlos
          pm2 reload ecosystem.config.js --update-env 2>/dev/null \
            || pm2 start ecosystem.config.js
          pm2 save
        EOF

    - name: âœ… Verificar deploy
      run: |
        echo "âœ… Deploy completado exitosamente"
        echo "ğŸ–¥ï¸  VPS: ${{ secrets.DO_HOST }}"
        echo "ğŸ“ Ruta: ${{ secrets.DO_PATH }}"
        echo "ğŸŒ Servicio: whatsapp-service (PM2)"
        echo "ğŸ”Œ Puerto interno: 3001"
